<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Feedback</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="p-6 bg-gray-100 text-center">
<h2 class="text-2xl font-bold mb-4">Voice Feedback</h2>
<p class="mb-4 text-gray-600">Press Start to record your feedback, then Stop when done.</p>

<div class="mb-6">
    <button id="startBtn" class="bg-green-500 text-white px-4 py-2 rounded">Start</button>
    <button id="stopBtn" class="bg-red-500 text-white px-4 py-2 rounded ml-2">Stop</button>
    <button id="retakeBtn" class="bg-yellow-500 text-white px-4 py-2 rounded ml-2">Retake</button>
</div>

<form id="feedbackForm" method="POST" action="/submit_feedback/{{ visitor_id }}">
    <textarea name="feedback_text" id="feedbackText" rows="6"
        class="w-full p-2 border rounded" placeholder="Speech will appear here..."></textarea>
    <button type="submit" class="bg-blue-600 text-white px-4 py-2 mt-4 rounded">Submit</button>
</form>

<script>
let mediaRecorder, audioChunks = [];

document.getElementById("startBtn").onclick = async () => {
    let stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    audioChunks = [];
    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
    mediaRecorder.start();
};

document.getElementById("stopBtn").onclick = async () => {
    mediaRecorder.stop();
    mediaRecorder.onstop = async () => {
        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
        const formData = new FormData();
        formData.append('audio', audioBlob);

        const res = await fetch(`/upload_audio/{{ visitor_id }}`, { method: 'POST', body: formData });
        const data = await res.json();
        if (data.success) {
            document.getElementById("feedbackText").value = data.text;
        } else {
            alert("Could not process audio.");
        }
    };
};

document.getElementById("retakeBtn").onclick = () => {
    document.getElementById("feedbackText").value = "";
    alert("You can record again now.");
};
</script>
</body>
</html>
