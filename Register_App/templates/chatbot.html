<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visitor Chat Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        /* Custom scrollbar for chat window */
        .chat-messages::-webkit-scrollbar { width: 8px; }
        .chat-messages::-webkit-scrollbar-thumb { background-color: #d1d5db; border-radius: 4px; }
        .chat-messages::-webkit-scrollbar-track { background-color: #f3f4f6; }

        /* Floating button position */
        #chat-button {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 50;
        }
        /* Chat window position - centered for standalone view */
        #chat-container {
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            display: flex; /* Always display for standalone version */
            flex-direction: column;
            margin: 50px auto;
        }
        
        /* Message bubble styles */
        .user-bubble {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            border-radius: 12px 12px 0 12px;
        }
        .assistant-bubble {
            background-color: #e5e7eb; /* gray-200 */
            color: #1f2937; /* gray-800 */
            border-radius: 12px 12px 12px 0;
        }
    </style>
</head>
<body class="min-h-screen p-4">

    <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">Visitor Chat Assistant (Standalone)</h1>

    <!-- Chat Window Container -->
    <div id="chat-container" class="bg-white rounded-xl shadow-2xl transition-all duration-300">
        <div class="p-4 bg-blue-600 text-white font-bold rounded-t-xl flex justify-between items-center">
            Visitor Assistant
        </div>
        
        <!-- Chat Messages -->
        <div id="chat-messages" class="chat-messages p-4 flex-1 overflow-y-auto space-y-3 h-[400px]">
            <div class="flex justify-start">
                <div class="assistant-bubble p-3 max-w-[80%] shadow-sm">
                    Hello! I'm your visitor assistant. How can I help you with your visit today?
                </div>
            </div>
        </div>

        <!-- Chat Input -->
        <div class="p-4 border-t border-gray-200 flex">
            <input type="text" id="chat-input" placeholder="Ask a question..."
                   class="flex-1 px-4 py-2 border border-gray-300 rounded-l-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
            <button onclick="sendMessage()" id="send-btn" disabled
                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-r-lg transition duration-150 disabled:opacity-50">
                Send
            </button>
        </div>
    </div>

    <script>
        // --- API Configuration ---
        const API_KEY = ""; // Replace with your actual key or use the environment variable reference
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;

        // --- Chat Elements ---
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        
        // Enable/Disable send button based on input
        chatInput.addEventListener('input', () => {
            sendBtn.disabled = chatInput.value.trim() === '';
        });
        // Send message on Enter key press
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !sendBtn.disabled) {
                sendMessage();
            }
        });


        // --- Helper Functions ---
        
        function displayMessage(text, sender) {
            const msgDiv = document.createElement('div');
            const style = sender === 'user' 
                ? 'flex justify-end' 
                : 'flex justify-start';
            const bubbleStyle = sender === 'user'
                ? 'user-bubble' 
                : 'assistant-bubble';

            msgDiv.className = style;
            msgDiv.innerHTML = `
                <div class="p-3 rounded-xl max-w-[80%] shadow-md ${bubbleStyle}">
                    ${text}
                </div>
            `;
            chatMessages.appendChild(msgDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight; // Scroll to bottom
            return msgDiv.querySelector('div'); // Return the bubble element for updates
        }

        // Exponential Backoff for API calls
        async function fetchWithRetry(url, options, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429) { // Rate limit
                        const delay = Math.pow(2, i) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    if (i === retries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        async function sendMessage() {
            const userQuery = chatInput.value.trim();
            if (!userQuery) return;

            displayMessage(userQuery, 'user');
            chatInput.value = '';
            sendBtn.disabled = true;

            const systemPrompt = "You are a friendly Visitor Registration Assistant for a corporate building. Keep answers brief and focused on the registration process, directions, meeting logistics, and building policies. Do not discuss programming, coding, or historical facts. Assume the visitor is at home or walking towards the building and needs practical advice.";
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                tools: [{ "google_search": {} }], // Enable grounding for external info
            };

            const assistantBubble = displayMessage("Assistant is typing...", 'assistant');
            
            try {
                const response = await fetchWithRetry(GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                
                const candidate = result.candidates?.[0];
                let assistantText = "Sorry, I encountered an error. Please try again or ask security staff.";

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    assistantText = candidate.content.parts[0].text;
                }
                
                assistantBubble.textContent = assistantText; // Replace "typing..." with response
                chatMessages.scrollTop = chatMessages.scrollHeight; // Scroll to bottom

            } catch (error) {
                console.error("Gemini API Error:", error);
                assistantBubble.textContent = "There was a network issue. Please check your console for details.";
            } finally {
                sendBtn.disabled = false;
            }
        }

    </script>
</body>
</html>
